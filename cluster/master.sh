#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

function format_hdfs() {
    echo
    echo "***************************************************************************"
    echo rm -R /tmp/*
    echo "***************************************************************************"
    rm -R /tmp/*

    HDFS_DIR=/usr/src/hdfsdata
    echo
    echo "***************************************************************************"
    echo "preparing namenode and datanode in $HDFS_DIR"
    echo "***************************************************************************"
    rm -fr $HDFS_DIR/*
    mkdir $HDFS_DIR/namenode
    mkdir $HDFS_DIR/datanode

    echo
    echo "***************************************************************************"
    echo hdfs namenode -format
    echo "***************************************************************************"
    echo 'Y' | hdfs namenode -format
}

function start_master() {
    echo
    echo "***************************************************************************"
    echo service ssh start
    echo "***************************************************************************"
    service ssh start

    if [[ -e "$FLAGS_DIR/format-hdfs" ]]; then
        format_hdfs
        rm "$FLAGS_DIR/format-hdfs"
    fi

    echo
    echo "***************************************************************************"
    echo start-dfs.sh
    echo "***************************************************************************"
    start-dfs.sh

    echo
    echo "***************************************************************************"
    echo start-yarn.sh
    echo "***************************************************************************"
    start-yarn.sh

    echo
    echo "***************************************************************************"
    echo sleep 30
    echo "***************************************************************************"
    sleep 30

    while true; do
        echo
        echo "***************************************************************************"
        echo hdfs dfsadmin -report
        echo "***************************************************************************"
        hdfs dfsadmin -report

        sleep 60
    done
}

function stop_master() {
    echo
    echo "***************************************************************************"
    echo stop-yarn.sh
    echo "***************************************************************************"
    stop-yarn.sh

    echo
    echo "***************************************************************************"
    echo stop-dfs.sh
    echo "***************************************************************************"
    stop-dfs.sh

    echo
    echo "***************************************************************************"
    echo service ssh stop
    echo "***************************************************************************"
    service service ssh stop
}

trap stop_master SIGTERM

start_master
stop_master
